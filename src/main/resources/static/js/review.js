// Ïø†ÌÇ§ÏóêÏÑú 'Authorization' ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§.
const token = Cookies.get('Authorization');

// JWT ÌÜ†ÌÅ∞Ïùò Í∂åÌïú ÌôïÏù∏
const tokenPayload = parseJwtPayload(token); // JWT ÌÜ†ÌÅ∞ÏùÑ Ìï¥ÏÑùÌïòÏó¨ payloadÎ•º Í∞ÄÏ†∏Ïò§Îäî Ìï®ÏàòÎ°ú ÏßÅÏ†ë Íµ¨ÌòÑÌï¥Ïïº Ìï©ÎãàÎã§.
const role = tokenPayload.auth;
const userName = tokenPayload.sub;

// ÌòÑÏû¨ URLÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§.
const currentURL = window.location.href;

// URLÏóêÏÑú Í≤ΩÎ°ú ÌååÎùºÎØ∏ÌÑ∞ Î∂ÄÎ∂ÑÏùÑ Ï∂îÏ∂úÌï©ÎãàÎã§.
const pathSegments = currentURL.split('/');

// Í≤ΩÎ°ú ÌååÎùºÎØ∏ÌÑ∞ Ï§ëÏóêÏÑú ÌïÑÏöîÌïú Í∞íÏùÑ Ï∂îÏ∂úÌï©ÎãàÎã§.
const festivalId = pathSegments[pathSegments.length - 4];
const reviewId = pathSegments[pathSegments.length - 2];

$(document).ready(function () {
    getReview();
});

function parseJwtPayload(token) {
    const base64Url = token.split('.')[1]; // JWTÏùò Îëê Î≤àÏß∏ Î∂ÄÎ∂ÑÏù¥ ÌéòÏù¥Î°úÎìúÏûÖÎãàÎã§.
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); // URL ÏïàÏ†ÑÌïú Base64 Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join('')); // Base64 ÎîîÏΩîÎî© Î∞è URL ÎîîÏΩîÎî©

    return JSON.parse(jsonPayload); // JSON Î¨∏ÏûêÏó¥ÏùÑ Í∞ùÏ≤¥Î°ú ÌååÏã±
}

function getReview() {
    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}`;
    $.ajax({
        url: apiUrl,
        type: 'GET',
        success: function (data) {
            console.log(data);
            var imageSrc = data.fileUrl;
            let html = `
                <div  class="post-header">
                    <div class="post-title">${data.title}</div>
                    <div class="post-meta"><a href="#" style="text-decoration: none" onclick="moveFestival(${data.festivalId})">${data.festivalTitle}</a></div>
                    <div class="post-meta">${data.createdAtTimeAgo}</div>
                </div>
                <div class="scrollable-content">
                    <img src="${imageSrc}" alt="Review Image" class="post-image">
                    <div class="post-content" style="display: flex">
                        <a href="#" style="text-decoration: none"><strong onclick="moveProfile(${data.userId})" style="font-size: larger; float: right; margin-right: 20px">${data.userNickname}</strong></a>
                        ${data.content}
                    </div>
                    <div class="actions">
                        <div id="heart-group" style="display: flex">
                            <a href="" id="heart-btn" class="heart-btn" style="text-decoration: none; font-size: 25px;" onclick="cancelReviewLike()">‚ù§Ô∏è</a>
                            <a href="" id="not-heart-btn" class="heart-btn" style="text-decoration: none; font-size: 25px; display: none" onclick="addReviewLike()">ü§ç</a>
                            <span style="font-size: 20px; margin-left: 5px; margin-top: 5px">${data.likeCnt}</span>
                        </div>
                        <div id="reviewUDContainer" class="edit-delete">
                            <a href="${apiUrl}/edit-page" class="edit">Edit</a>
                            <button class="delete" onclick="alertDeleteReview()">Delete</button>
                        </div>
                    </div>
                    <div class="comment-post-container-before"></div>
                    <div style="margin-top: 20px">
                        <strong>Comments</strong>
                    </div>
                    <div id="comment-post" class="comment-post-container" style="margin-top: 20px">
                        <textarea id="commentInput" name="commentInput" rows="2" required=""></textarea>
                        <button type="submit" class="comment-post" onclick="postComment()">ÏûëÏÑ±</button>                        
                    </div>                    
                    <div id="review-comment"></div>
                    <div id="review-comment-pagination" style="text-align: center;"><a>1</a></div>
                </div>
                `;
            $('#review-page').html(html);
            showReviewLikeBtn();
            showReviewUDContainer(role, userName, data.username);
            getComments(0);
        },
        error: function (err) {
            console.log('Error:', err);
        }
    });
}

function showReviewLikeBtn() {
    var heartBtn = document.getElementById('heart-btn');
    var notHeartBtn = document.getElementById('not-heart-btn');

    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}/user-like`
    $.ajax({
        url: apiUrl,
        type: 'GET',
        success: function (data) {
            console.log(data);
            if (data) {
                heartBtn.style.display = 'inline-block';
                notHeartBtn.style.display = 'none';
            } else {
                heartBtn.style.display = 'none';
                notHeartBtn.style.display = 'inline-block';
            }
        },
        error: function (err) {
            console.log('Error:', err);
        }
    });
}

function addReviewLike() {
    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}/likes`
    $.ajax({
        url: apiUrl,
        type: 'POST',
        success: function (data) {
            console.log(data);
            alert(data.statusMessage);
            getReview();
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}

function cancelReviewLike() {
    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}/likes-cancel`
    $.ajax({
        url: apiUrl,
        type: 'DELETE',
        success: function (data) {
            console.log(data);
            alert(data.statusMessage);
            getReview();
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}

function showReviewUDContainer(role, userName, editorName) {
    if (role === 'ADMIN' || userName === editorName) {
        $('#reviewUDContainer').show();
    } else {
        $('#reviewUDContainer').hide();
    }
}

async function getComments(pageNum) {
    try {
        const commentData = await $.ajax({
            url: `/api/festivals/${festivalId}/reviews/${reviewId}/comments?page=${pageNum}`,
            type: 'GET'
        });

        let html = '';
        for (let i = 0; i < commentData.content.length; i++) {
            let commentDt = commentData.content[i];
            // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏùò Ïù¥Î¶ÑÍ≥º ÎåìÍ∏Ä ÏûëÏÑ±ÏûêÏùò Ïù¥Î¶ÑÏùÑ ÎπÑÍµêÌïòÏó¨ ÏàòÏ†ï Î∞è ÏÇ≠Ï†ú Î≤ÑÌäºÏùò Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï
            const isCurrentUser = userName === commentDt.username;
            const isAdmin = role === 'ADMIN';

            // ÎπÑÎèôÍ∏∞Î°ú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Í≥† Ï≤òÎ¶¨
            const isCommentLike = await getCommentLike(commentDt.id);

            html += `
                    <div class="comment">
                        <div class="comment-author" style="color: #5F5F5F; font-size: 12px"><a href="#" style="text-decoration: none" onclick="moveProfile(${commentDt.userId})">${commentDt.userNickname}</a></div>
                        <p id="comment${commentDt.id}" class="comment-content" style="font-size: 16px">${commentDt.content}</p>
                        <div class="comment-content-container" id="comment-container${commentDt.id}" style="display: flex; justify-content: space-between;">
                            <div style="display: flex">${isCommentLike ? `
                                    <a href="" id="comment-heart-btn" class="heart-btn" style="text-decoration: none; font-size: 15px;" onclick="cancelCommentLike(${commentDt.id})">‚ù§Ô∏è</a>
                                ` : `
                                <a href="" id="comment-not-heart-btn" class="heart-btn" style="text-decoration: none; font-size: 15px;" onclick="addCommentLike(${commentDt.id})">ü§ç</a>`}
                            <p id="commentLikeCnt${commentDt.id}" class="comment-content" style="font-size: 14px; margin-left: 5px; margin-top: 5px">${commentDt.likeCnt}</p>
                            </div>
                            <div id="commentUDContainer" style="float: right; margin-top: 10px">
                                ${isCurrentUser || isAdmin ? `
                                    <a href="#" style="color: #5F5F5F; font-size: 14px" onclick="showCommentInput(${commentDt.id}, '${commentDt.content}')">ÏàòÏ†ï</a>
                                    <a href="#" style="color: #5F5F5F; font-size: 14px; margin-left: 10px" onclick="alertDeleteComment(${commentDt.id})">ÏÇ≠Ï†ú</a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
        }
        $('#review-comment').html(html);

        makeCommentPagination(commentData);
    } catch (err) {
        console.log('Error:', err);
    }
}

function makeCommentPagination(page){
    let pagination = $("#review-comment-pagination");
    pagination.empty();

    let cur = page.number; // 0Î∂ÄÌÑ∞ ÏÑºÎã§.
    let endPage = Math.ceil((cur + 1) / 10.0) * 10; // 1~10
    let startPage = endPage - 9; // 1~10
    if (endPage > page.totalPages - 1) // totalPageÎäî 1Î∂ÄÌÑ∞ ÏÑºÎã§ Í∑∏ÎûòÏÑú 1ÏùÑ ÎπºÏ§å
    {
        endPage = page.totalPages;
    }

    if (cur > 0) // Ïù¥Ï†Ñ Î≤ÑÌäº
    {
        pagination.append(
            `<a onclick='getComments(${cur - 1})'><button>Ïù¥Ï†Ñ</button></a>`);
    }

    for (let i = startPage; i <= endPage; i++) { // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
        pagination.append(
            `<a onclick="getComments(${i - 1});"><button>${i}</button></a>`);
    }
    if (cur + 1 < page.totalPages) // Îã§Ïùå Î≤ÑÌäº
    {
        pagination.append(
            `<a onclick='getComments(${cur + 1})'><button>Îã§Ïùå</button></a>`);
    }
}

async function getCommentLike(commentId) {
    try {
        const boolean = await $.ajax({
            url: `/api/festivals/${festivalId}/reviews/${reviewId}/comments/${commentId}/user-like`,
            type: 'GET'
        });
        return !!boolean;
    } catch (err) {
        console.log('Error:', err);
        return false;
    }
}

function addCommentLike(commentId) {
    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}/comments/${commentId}/likes`
    $.ajax({
        url: apiUrl,
        type: 'POST',
        success: function (data) {
            console.log(data);
            alert(data.statusMessage);
            getComments();
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}

function cancelCommentLike(commentId) {
    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}/comments/${commentId}/likes-cancel`
    $.ajax({
        url: apiUrl,
        type: 'DELETE',
        success: function (data) {
            console.log(data);
            alert(data.statusMessage);
            getComments();
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}

function alertDeleteReview() {
    // Í≤ΩÍ≥†Ï∞ΩÏùÑ ÎùÑÏõÅÎãàÎã§.
    const confirmation1 = confirm("Î¶¨Î∑∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");

    // ÏÇ¨Ïö©ÏûêÍ∞Ä ÌôïÏù∏ÏùÑ ÎàÑÎ•¥Î©¥ Î©îÏÜåÎìúÎ•º Ïã§ÌñâÌï©ÎãàÎã§.
    if (confirmation1) {
        const confirmation2 = confirm("ÏÇ≠Ï†úÎ•º ÏßÑÌñâÌï† Í≤ΩÏö∞ Ïó∞Í¥ÄÎêú ÎåìÍ∏Ä Î™®ÎëêÍ∞Ä Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§. Í∑∏ÎûòÎèÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
        if (confirmation2) {
            deleteReview();
        }
    }
}

function deleteReview() {
    $.ajax({
        url: `/api/festivals/${festivalId}/reviews/${reviewId}`,
        type: 'DELETE',
        success: function (data) {
            alert(data.statusMessage);
            window.location.href = `/api/festivals/${festivalId}/page`;
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}

function postComment() {
    const content = document.querySelector('#commentInput').value;

    // DTO Í∞ùÏ≤¥ ÏÉùÏÑ±
    const requestDto = {
        content: content,
    };

    // ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏÜ°
    $.ajax({
        url: `/api/festivals/${festivalId}/reviews/${reviewId}/comments`,
        type: 'POST',
        data: JSON.stringify(requestDto),
        contentType: 'application/json',
        success: function (data) {
            alert(data.statusMessage);
            getReview();
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}


function showCommentInput(commentId, currentContent) {
    // ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ Ìè¨Ìï®ÌïòÎäî Ïª®ÌÖåÏù¥ÎÑà divÎ•º Ï∞æÏäµÎãàÎã§.
    const commentContainer = $(`#comment-container${commentId}`);

    // ÏÉàÎ°úÏö¥ ÏûÖÎ†• ÏöîÏÜåÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.
    const input = $('<textarea>', {
        rows: 2,
        id: `commentInput${commentId}`,
        style: 'width: 85%; font-size: 16px; margin-top: 10px',
    });
    input.val(currentContent);

    // ÏàòÏ†ïÏùÑ ÌôïÏù∏ÌïòÎäî Î≤ÑÌäºÏùÑ ÎßåÎì≠ÎãàÎã§.
    const saveButton = $('<a>', {
        href: '#',
        style: 'color: #5F5F5F; font-size: 14px; margin-left: 10px; margin-top:20px',
        click: function () {
            alertCommentModify(commentId);
        }
    }).text('ÌôïÏù∏');

    // ÏàòÏ†ïÏùÑ Ï∑®ÏÜåÌïòÎäî Î≤ÑÌäºÏùÑ ÎßåÎì≠ÎãàÎã§.
    const cancelButton = $('<a>', {
        href: '#',
        style: 'color: #5F5F5F; font-size: 14px; margin-left: 10px; margin-top:20px',
        click: function () {
            getComments();
        }
    }).text('Ï∑®ÏÜå');

    // ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†• ÏöîÏÜåÏôÄ Î≤ÑÌäºÏúºÎ°ú ÎåÄÏ≤¥Ìï©ÎãàÎã§.
    commentContainer.empty().append(input).append(saveButton).append(cancelButton);
}

function alertCommentModify(commentId) {
    // Í≤ΩÍ≥†Ï∞ΩÏùÑ ÎùÑÏõÅÎãàÎã§.
    const confirmation = confirm("ÎåìÍ∏ÄÏùÑ ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?");

    // ÏÇ¨Ïö©ÏûêÍ∞Ä ÌôïÏù∏ÏùÑ ÎàÑÎ•¥Î©¥ Î©îÏÜåÎìúÎ•º Ïã§ÌñâÌï©ÎãàÎã§.
    if (confirmation) {
        modifyComment(commentId);
    } else {
        getComments();
    }
}

function modifyComment(commentId) {
    const commentInput = document.getElementById(`commentInput${commentId}`);
    const requestDto = {
        content: commentInput.value
    };

    $.ajax({
        url: `/api/festivals/${festivalId}/reviews/${reviewId}/comments/${commentId}`,
        type: 'PUT',
        data: JSON.stringify(requestDto), // Îç∞Ïù¥ÌÑ∞ Í∞ùÏ≤¥Î•º JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°
        contentType: 'application/json',
        success: function (data) {
            alert('ÎåìÍ∏Ä ÏàòÏ†ï ÏôÑÎ£å!');
            getComments();
        },
        error: function (err) {
            alert(err.responseJSON.statusMessage);
            console.log('Error:', err);
            getComments();
        }
    });
}

function alertDeleteComment(commentId) {
    // Í≤ΩÍ≥†Ï∞ΩÏùÑ ÎùÑÏõÅÎãàÎã§.
    const confirmation = confirm("ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?");

    // ÏÇ¨Ïö©ÏûêÍ∞Ä ÌôïÏù∏ÏùÑ ÎàÑÎ•¥Î©¥ Î©îÏÜåÎìúÎ•º Ïã§ÌñâÌï©ÎãàÎã§.
    if (confirmation) {
        deleteComment(commentId);
    }
}

function deleteComment(commentId) {
    const apiUrl = `/api/festivals/${festivalId}/reviews/${reviewId}`
    $.ajax({
        url: apiUrl + `/comments/${commentId}`,
        type: 'DELETE',
        success: function (data) {
            alert(data.statusMessage);
            getReview();
        },
        error: function (err) {
            console.log('Error:', err);
            alert(err.responseJSON.statusMessage);
        }
    });
}

// ÌéòÏä§Ìã∞Î≤åÎ°ú Ïù¥ÎèôÌïòÍ∏∞
function moveFestival(festivalId) {
    window.location.href = `/api/festivals/${festivalId}/page`;
}

// ÌîÑÎ°úÌïÑÎ°ú Ïù¥ÎèôÌïòÍ∏∞
function moveProfile(userId) {
    window.location.href = `/api/users/${userId}/profile-page`;
}